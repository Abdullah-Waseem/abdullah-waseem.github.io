<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>64 Bit Operating System &middot; </title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://abdullah-waseem.github.io/favicon.ico" />
    <link rel="canonical" href="http://abdullah-waseem.github.io/64-bit-operating-system/" />

     <meta name="description" content="A step-by-step explanation of working of my 64-Bit Operating System.
Tools Used:
 VS Code Qemu Docker  Languages used:
 Assembly Language C Language  Step 1: Do" /> 

     
    
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="http://abdullah-waseem.github.io/image/os.png"/>
    
 
    <meta name="twitter:title" content="64 Bit Operating System"/>
    <meta name="twitter:description" content="A step-by-step explanation of working of my 64-Bit Operating System.
Tools Used:
 VS Code Qemu Docker  Languages used:
 Assembly Language C Language  Step 1: Do"/>
    <meta name="twitter:url" content="http://abdullah-waseem.github.io/64-bit-operating-system/" />
    <meta name="twitter:site" content="@Morixxyleth"/>

    <meta property="og:site_name" content="" />
    <meta property="og:title" content="64 Bit Operating System &middot; Abdullah Waseem Afzal" />
    <meta property="og:url" content="http://abdullah-waseem.github.io/64-bit-operating-system/" />
    <meta property="article:publisher" content="https://www.facebook.com/fakeghost" />

    <meta property="og:type" content="article" />
    <meta property="og:description" content="A step-by-step explanation of working of my 64-Bit Operating System.
Tools Used:
 VS Code Qemu Docker  Languages used:
 Assembly Language C Language  Step 1: Do" />

    <meta property="article:published_time" content="2021-04-22T17:30:50&#43;05:00" />
    

    <meta property="og:image" content="http://abdullah-waseem.github.io/image/os.png"/>


    <meta name="generator" content="Hugo 0.82.1" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="../built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="../css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/golang/">Projects</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/categories/food/">About</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="https://google.com/">External</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    <a class="social-link social-link-fb" href="https://www.facebook.com/fakeghost" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg></a>

                    <a class="social-link social-link-tw" href="https://twitter.com/Morixxyleth" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg></a>

                    <a class="social-link" href="https://github.com/Abdullah-Waseem" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>

<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      <article class="post-full post"> 
    <header class="post-full-header">
        <section class="post-full-meta">
            <time class="post-full-meta-date" datetime="2021-04-22">22 April 2021</time>
        </section>
        <h1 class="post-full-title">64 Bit Operating System</h1>
    </header>
    
    <figure class="post-full-image" style="background-image: url(http://abdullah-waseem.github.io/image/os.png)">
    </figure>

    <section class="post-full-content">
        <div class="kg-card-markdown">
        <p>A step-by-step explanation of working of my 64-Bit Operating System.</p>
<p>Tools Used:</p>
<ol>
<li>VS Code</li>
<li>Qemu</li>
<li>Docker</li>
</ol>
<p>Languages used:</p>
<ol>
<li>Assembly Language</li>
<li>C Language</li>
</ol>
<h2 id="step-1-docker-image">Step 1: Docker Image:</h2>
<p>We make a docker file and import a premade docker image that contains all the packages we need. We also need nasm to compile our assembly code and grub. Following is the code for that:</p>
<pre><code>FROM randomdude/gcc-cross-x86_64-elf // Premade image on the docker website

// Run these terminal commands in our linux virtual machine
RUN apt-get update 
RUN apt-get upgrade -y
RUN apt-get install -y nasm
RUN apt-get install -y xorriso
RUN apt-get install -y grub-pc-bin
RUN apt-get install -y grub-common

VOLUME /root/env
WORKDIR /root/env
</code></pre><p>To build the image we execute the following code in the terminal:</p>
<pre><code>docker build buildenv -t myos-buildenv

</code></pre><p>“buildenv” is the name of our folder containing docker file and myos is the tag of docker image.
To run this image we run the following code in the terminal:
docker run &ndash;rm -it -v &ldquo;%cd%&quot;:/root/env myos-buildenv
This gives us access to the virtual linux machine.</p>
<h2 id="step-2-multiboot-header--main-file-to-print-ok-on-screen">Step 2: Multiboot Header &amp; Main File (to print OK on screen):</h2>
<p>The multiboot header tells the bootloader where to load the operating system from and how. The magic number tells the bootloader about multiboot2.
Multiboot2 is an interface which tells the bootloader how it should be doing things.
When loading the operating system this magic number can appear anywhere which can cause the bootloader to think that it might be reading a header so we include a checksum with it to help the bootloader verify the actual multiboot header. Following is the code of our multiboot header:</p>
<pre><code>section .multiboot_header
header_start:
	; magic number for multiboot2
	dd 0xe85250d6 
	; architecture
	dd 0 ; protected mode 
	; header length
	dd header_end - header_start
	; checksum
	dd 0x100000000 - (0xe85250d6 + 0 + (header_end - header_start))

	; end tag
	dw 0
	dw 0
	dd 8
header_end:

</code></pre><p>To print OK on the screen we make an assembly file named main.</p>
<pre><code>global start ; global so we can access it from anywhere

section .text
bits 32 ; our os is still in 32 bit mode
start:
    mov dword [0bx8000], 0x2f4b2f4f ; 0bx8000 is where the video memory starts and 
    we are putting 0x2f4b2f4f, which represents OK, in it

    hlt ; stop the cpu from executing further
</code></pre><h2 id="step-3-linker-file">Step 3: Linker FIle:</h2>
<p>The linker file tells the order in which our operating system should be linked. We define the start and step by step define the sections to call and execute. Following is the code of our linker file:</p>
<pre><code>ENTRY(start)

SECTIONS
{
	. = 1M;
	.boot :
	{
		KEEP(*(.multiboot_header)) 
	}
	.text :
	{
		*(.text)
	}
}

</code></pre><p>The start label is where we print OK so we are telling to bootloader to put this as starting point. The .1M is to align the memory 1 Megabyte further.</p>
<h2 id="step-5-the-makefile">Step 5: The MakeFile:</h2>
<p>Make file makes compiling and recompiling a very fast and efficient process by making sure that only those object files are updated which have been changed.
First we make variables to store all our source files and object files. Then we move onto dependency line. The part before the colon is the dependency or target file, in this case it is x86_64_asm_object_files, the variable that has all the data of our object files. After the colon we have the source files. So if any of them changes then it recompiles.</p>
<pre><code>x86_64_asm_source_files := $(shell find src/impl/x86_64 -name *.asm)
x86_64_asm_object_files := $(patsubst src/impl/x86_64/%.asm, build/x86_64/%.o, $(x86_64_asm_source_files))

$(x86_64_asm_object_files): build/x86_64/%.o : src/impl/x86_64/%.asm
	mkdir -p $(dir $@) &amp;&amp; \
	nasm -f elf64 $(patsubst build/x86_64/%.o, src/impl/x86_64/%.asm, $@) -o $@

.PHONY: build-x86_64
build-x86_64: $(x86_64_asm_object_files)
	mkdir -p dist/x86_64 &amp;&amp; \
	x86_64-elf-ld -n -o dist/x86_64/kernel.bin -T targets/x86_64/linker.ld $(x86_64_asm_object_files) &amp;&amp; \
	cp dist/x86_64/kernel.bin targets/x86_64/iso/boot/kernel.bin &amp;&amp; \
	grub-mkrescue /usr/lib/grub/i386-pc -o dist/x86_64/kernel.iso targets/x86_64/iso
</code></pre><h2 id="step-6-running-the-32-bit-os">Step 6: Running the 32-Bit OS:</h2>
<p>In our make file used the phony command : build-x86_64 to build the operating system.</p>
<pre><code>make build-x86_64
</code></pre><p>We wrote shell commands in make file to so that the .iso file appears in the dist folder. Now we will use qemu to emulate our operating system.</p>
<pre><code>qemu-system-x86_64 -cdrom dist/x86_64/kernel.iso
</code></pre><p>A window with text OK will appear on screen making sure our OS is running.</p>
<h1 id="64-bit-mode-conversion">64-Bit Mode Conversion:</h1>
<h2 id="step-1-modifying-the-mainasm-file">Step 1: Modifying the main.asm File:</h2>
<p>First, we check if the CPU supports 64-bit or not. Hence, we setupchecks for long mode. Conversion to 64-bit requires page tables. Tosetup page tables we require a descriptor table. The global descriptortable contains of the access rights, properties and size of data orcode segments of the various areas in the computer’s memory.</p>
<h2 id="step-2-print-header-file">Step 2: Print Header File:</h2>
<p>To print anything on the screen other than OK we need to make our ownprint header file. We will use c language for this code and use thevideo buffer memory to print characters. The video memory begins at0xb8000 so we store it in buffer variable. To display a character onscreen we store it at the required index in the buffer. Then we definea kernel_main function to print everything after our OS boots.</p>
<h2 id="step-3-makefile-modifications">Step 3: MakeFile modifications:</h2>
<p>We modify the previous command for the C source files. We can make changes to main.c to print whatever we want.
After modifications we run the following commands:</p>
<pre><code>docker run --rm -it -v &quot;%cd%&quot;:/root/env myos-buildenv
</code></pre><p>Then:</p>
<pre><code>make build-x86_64
</code></pre><p>then exit the docker by typing :</p>
<pre><code>exit
</code></pre><p>Now run this in qemu:</p>
<pre><code>qemu-system-x86_64 -cdrom dist/x86_64/kernel.iso
</code></pre><p>A window with your required text should pop up.</p>
<p><img src="/images/os.png" alt="os-pic"></p>
    
        </div>
    </section>

    <footer class="post-full-footer">
      <section class="author-card">
        <img class="author-profile-image" src="https://github.com/adam-p/markdown-here/raw/master/src/common/images/icon48.png" alt="Author" />
        <section class="author-card-content">
            <h4 class="author-card-name"><a href="http://abdullah-waseem.github.io/">AW</a></h4>
                <p>Coder,Gamer</p>
        </section>
      </section>
    </footer>
</article>
    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      

      
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <div class="floating-header-logo">
    <a href="http://abdullah-waseem.github.io/">
      
      <span></span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">64 Bit Operating System</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/></svg>
    </div>
    
    <a class="floating-header-share-tw" href="https://twitter.com/share?text=64%20Bit%20Operating%20System&amp;url=http%3a%2f%2fabdullah-waseem.github.io%2f64-bit-operating-system%2f"
          onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
      </a>
      <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fabdullah-waseem.github.io%2f64-bit-operating-system%2f"
          onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
      </a>
  </div>

  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/">EM</a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        <a href="https://www.facebook.com/fakeghost" target="_blank" rel="noopener">Facebook</a>
        <a href="https://twitter.com/Morixxyleth" target="_blank" rel="noopener">Twitter</a>
        <a href="https://github.com/Abdullah-Waseem" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="http://abdullah-waseem.github.io/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>



    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
